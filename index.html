<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CRM PRO ‚Äì All-in-One + Video (Supabase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .btn{padding:.65rem 1rem;border-radius:14px;font-weight:900}
    .navbtn{padding:.7rem 1rem;border-radius:14px;font-weight:900;background:#f1f5f9}
    .navbtn.active{background:#0f172a;color:#fff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    video{background:#0b1220}
  </style>
</head>

<body class="bg-slate-100 text-slate-900">
<div id="toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-3 rounded-xl shadow-lg text-sm font-bold z-50 bg-slate-900 text-white"></div>

<script>
  // =========================
  // FIX: Keys sind gesetzt (wie du wolltest)
  // =========================
  const SUPABASE_URL = "https://pgcjsyzoukyynkufupms.supabase.co";
  const SUPABASE_KEY = "sb_publishable_uyKhe83Crckp93AjCrIruw_NAuV16p2";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const $ = (id)=>document.getElementById(id);
  const toast = (msg, type="info")=>{
    const el = $("toast");
    el.textContent = msg;
    el.className = "fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-3 rounded-xl shadow-lg text-sm font-bold z-50 " +
      (type==="err" ? "bg-red-600 text-white" : type==="ok" ? "bg-green-600 text-white" : "bg-slate-900 text-white");
    el.classList.remove("hidden");
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>el.classList.add("hidden"), 2500);
  };
  const escapeHtml = (str)=> String(str ?? "").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s]));
  const fmt = (d)=> new Date(d).toLocaleString("de-DE");

  // =========================
  // App State
  // =========================
  const state = {
    user:null,
    profile:null,
    workspaces:[],
    activeWorkspace:null,

    // Realtime channels
    rt:null,

    // Video/WebRTC
    call: {
      roomId:"",
      inRoom:false,
      role:null, // "caller" | "answerer"
      pc:null,
      localStream:null,
      remoteStream:null,
      channel:null,
      micOn:true,
      camOn:true,
      ready:false,
    }
  };

  // =========================
  // UI helpers
  // =========================
  function show(view){
    ["view_login","view_app"].forEach(v=>$(v).classList.add("hidden"));
    $(view).classList.remove("hidden");
  }
  function nav(id){
    document.querySelectorAll("[data-panel]").forEach(p=>p.classList.add("hidden"));
    $(id).classList.remove("hidden");
    document.querySelectorAll(".navbtn").forEach(b=>b.classList.remove("active"));
    $("nav_"+id).classList.add("active");
  }

  // =========================
  // AUTH
  // =========================
  async function signIn(){
    const email = $("li_email").value.trim();
    const password = $("li_pass").value.trim();
    if(!email || !password) return toast("Bitte Email & Passwort.", "err");

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) return toast(error.message, "err");

    await boot();
    toast("Eingeloggt.", "ok");
  }

  async function signUp(){
    const email = $("su_email").value.trim();
    const password = $("su_pass").value.trim();
    const username = $("su_user").value.trim() || email.split("@")[0];
    if(!email || !password) return toast("Bitte Email & Passwort.", "err");

    const { error } = await supabase.auth.signUp({ email, password });
    if(error) return toast(error.message, "err");

    toast("Account erstellt. Falls Email-Confirm aktiv: best√§tigen.", "ok");
    // Wenn Session direkt da ist, booten:
    await boot();
    if(state.user) await ensureProfile(username);
  }

  async function signOut(){
    await supabase.auth.signOut();
    location.reload();
  }

  async function loadSession(){
    const { data, error } = await supabase.auth.getUser();
    if(error) console.warn(error);
    state.user = data?.user || null;
  }

  // =========================
  // PROFILE / WORKSPACE
  // =========================
  async function ensureProfile(usernameFallback="User"){
    if(!state.user) return;
    const { data: prof, error } = await supabase
      .from("profiles")
      .select("*")
      .eq("user_id", state.user.id)
      .maybeSingle();

    if(error) console.warn(error);

    if(!prof){
      // Versuch insert (wenn RLS das erlaubt)
      const ins = await supabase.from("profiles").insert({
        user_id: state.user.id,
        username: usernameFallback,
        role: "user"
      });
      if(ins.error) console.warn(ins.error);
      const res = await supabase.from("profiles").select("*").eq("user_id", state.user.id).maybeSingle();
      state.profile = res.data || null;
    } else {
      state.profile = prof;
    }
    renderHeader();
  }

  async function loadWorkspaces(){
    const { data, error } = await supabase.from("workspaces").select("*").order("created_at",{ascending:false});
    if(error){ console.warn(error); state.workspaces=[]; return; }
    state.workspaces = data || [];
  }

  async function ensureWorkspace(){
    await loadWorkspaces();
    if(state.workspaces.length === 0){
      const name = (state.profile?.username || "Mein") + " Workspace";
      const { data: ws, error } = await supabase.from("workspaces").insert({ name }).select("*").single();
      if(error) { console.warn(error); return; }

      const m = await supabase.from("workspace_members").insert({
        workspace_id: ws.id,
        user_id: state.user.id,
        member_role: "admin"
      });
      if(m.error) console.warn(m.error);

      await loadWorkspaces();
    }
    state.activeWorkspace = state.workspaces[0] || null;
    renderWorkspacePicker();
  }

  async function createWorkspace(){
    const name = prompt("Workspace Name:");
    if(!name) return;
    const { data: ws, error } = await supabase.from("workspaces").insert({ name }).select("*").single();
    if(error) return toast(error.message,"err");

    const m = await supabase.from("workspace_members").insert({
      workspace_id: ws.id,
      user_id: state.user.id,
      member_role: "admin"
    });
    if(m.error) console.warn(m.error);

    await loadWorkspaces();
    state.activeWorkspace = state.workspaces.find(w=>w.id===ws.id) || state.workspaces[0];
    renderWorkspacePicker();
    toast("Workspace erstellt.","ok");
  }

  async function switchWorkspace(id){
    state.activeWorkspace = state.workspaces.find(w=>w.id===id) || null;
    renderWorkspacePicker();
    toast("Workspace gewechselt.","ok");
    // Video room trennt sich automatisch, damit es sauber bleibt
    await leaveRoom(true);
  }

  function renderHeader(){
    $("hdr_email").textContent = state.user?.email || "‚Äî";
    $("hdr_uid").textContent = state.user?.id ? state.user.id.slice(0,8) : "‚Äî";
    $("hdr_name").textContent = state.profile?.username || "User";
    $("hdr_admin").classList.toggle("hidden", !state.profile?.is_admin);
  }

  function renderWorkspacePicker(){
    const sel = $("ws_select");
    sel.innerHTML = state.workspaces.map(w=>`
      <option value="${w.id}" ${state.activeWorkspace?.id===w.id ? "selected":""}>
        ${escapeHtml(w.name)} (${w.id.slice(0,6)})
      </option>
    `).join("");
    $("ws_name").textContent = state.activeWorkspace?.name || "‚Äî";
  }

  // =========================
  // VIDEO / WEBRTC (Meetings)
  // Signaling √ºber Supabase Realtime Broadcast
  // =========================
  const ICE_SERVERS = [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "stun:stun1.l.google.com:19302" },
  ];

  function randomRoom(){
    return "room_" + Math.random().toString(36).slice(2,10);
  }

  async function initLocalMedia(){
    if(state.call.localStream) return;
    try{
      state.call.localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      $("localVideo").srcObject = state.call.localStream;
      state.call.micOn = true;
      state.call.camOn = true;
      renderCallState();
    } catch(e){
      console.error(e);
      toast("Kamera/Mikro blockiert. Browser erlauben.", "err");
      throw e;
    }
  }

  function makePC(){
    const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
    state.call.remoteStream = new MediaStream();
    $("remoteVideo").srcObject = state.call.remoteStream;

    pc.ontrack = (ev)=>{
      ev.streams[0].getTracks().forEach(t=> state.call.remoteStream.addTrack(t));
    };

    pc.onicecandidate = (ev)=>{
      if(ev.candidate){
        sendSignal({ type:"ice", candidate: ev.candidate });
      }
    };

    pc.onconnectionstatechange = ()=>{
      $("connState").textContent = pc.connectionState;
      if(pc.connectionState === "connected") toast("Verbunden ‚úÖ", "ok");
    };

    // Local tracks
    state.call.localStream.getTracks().forEach(track=>{
      pc.addTrack(track, state.call.localStream);
    });

    return pc;
  }

  async function joinRoom(asNew=false){
    if(!state.activeWorkspace) return toast("Kein Workspace.", "err");

    const room = (asNew ? randomRoom() : $("roomInput").value.trim());
    if(!room) return toast("Room-ID fehlt.", "err");

    state.call.roomId = room;
    $("roomInput").value = room;

    await initLocalMedia();

    // Channel unique pro workspace + room
    const chanName = `call:${state.activeWorkspace.id}:${room}`;

    // cleanup
    if(state.call.channel) supabase.removeChannel(state.call.channel);

    state.call.channel = supabase.channel(chanName);

    // Broadcast listener
    state.call.channel.on("broadcast", { event:"signal" }, async (payload)=>{
      const msg = payload.payload;
      if(!msg || msg.from === state.user.id) return;

      // Only accept same room
      if(msg.room !== state.call.roomId) return;

      try{
        if(msg.type === "offer"){
          // I'm answerer
          if(!state.call.pc){
            state.call.role = "answerer";
            state.call.pc = makePC();
          }
          await state.call.pc.setRemoteDescription(msg.offer);
          const answer = await state.call.pc.createAnswer();
          await state.call.pc.setLocalDescription(answer);
          sendSignal({ type:"answer", answer });
          state.call.inRoom = true;
          renderCallState();
        } else if(msg.type === "answer"){
          if(state.call.pc){
            await state.call.pc.setRemoteDescription(msg.answer);
            state.call.inRoom = true;
            renderCallState();
          }
        } else if(msg.type === "ice"){
          if(state.call.pc && msg.candidate){
            await state.call.pc.addIceCandidate(msg.candidate);
          }
        } else if(msg.type === "hangup"){
          toast("Gegenstelle hat aufgelegt.", "info");
          await leaveRoom(true);
        }
      } catch(e){
        console.error(e);
        toast("Signaling Fehler: "+ (e?.message||e), "err");
      }
    });

    const { error } = await state.call.channel.subscribe();
    if(error){
      console.error(error);
      return toast("Realtime subscribe failed: "+error.message, "err");
    }

    state.call.inRoom = true;
    state.call.role = null;
    state.call.pc = null;
    renderCallState();
    toast("Im Raum: "+room, "ok");
  }

  function sendSignal(payload){
    if(!state.call.channel) return;
    state.call.channel.send({
      type:"broadcast",
      event:"signal",
      payload: {
        ...payload,
        room: state.call.roomId,
        from: state.user.id,
        ts: Date.now()
      }
    });
  }

  async function startCall(){
    if(!state.call.inRoom) return toast("Erst Raum joinen.", "err");
    await initLocalMedia();

    // Caller creates offer
    state.call.role = "caller";
    state.call.pc = makePC();

    const offer = await state.call.pc.createOffer({ offerToReceiveAudio:true, offerToReceiveVideo:true });
    await state.call.pc.setLocalDescription(offer);
    sendSignal({ type:"offer", offer });
    renderCallState();
    toast("Anruf gestartet‚Ä¶", "info");
  }

  async function leaveRoom(silent=false){
    try{
      if(state.call.pc){
        state.call.pc.ontrack = null;
        state.call.pc.onicecandidate = null;
        state.call.pc.close();
      }
    } catch(e){}

    if(state.call.channel){
      try { supabase.removeChannel(state.call.channel); } catch(e){}
    }

    state.call.channel = null;
    state.call.pc = null;
    state.call.role = null;
    state.call.inRoom = false;
    $("connState").textContent = "idle";

    if(!silent) toast("Raum verlassen.", "info");
    renderCallState();
  }

  async function hangup(){
    sendSignal({ type:"hangup" });
    await leaveRoom(true);
    toast("Aufgelegt.", "info");
  }

  function toggleMic(){
    if(!state.call.localStream) return;
    state.call.micOn = !state.call.micOn;
    state.call.localStream.getAudioTracks().forEach(t=> t.enabled = state.call.micOn);
    renderCallState();
  }

  function toggleCam(){
    if(!state.call.localStream) return;
    state.call.camOn = !state.call.camOn;
    state.call.localStream.getVideoTracks().forEach(t=> t.enabled = state.call.camOn);
    renderCallState();
  }

  function renderCallState(){
    $("roomBadge").textContent = state.call.roomId || "‚Äî";
    $("roleBadge").textContent = state.call.role || "‚Äî";
    $("micBadge").textContent = state.call.micOn ? "Mic ON" : "Mic OFF";
    $("camBadge").textContent = state.call.camOn ? "Cam ON" : "Cam OFF";

    $("btnStartCall").disabled = !state.call.inRoom;
    $("btnHangup").disabled = !state.call.inRoom;

    $("btnMic").textContent = state.call.micOn ? "Mic aus" : "Mic an";
    $("btnCam").textContent = state.call.camOn ? "Cam aus" : "Cam an";
  }

  // =========================
  // Boot
  // =========================
  async function boot(){
    await loadSession();
    if(!state.user){
      show("view_login");
      return;
    }
    show("view_app");
    await ensureProfile();
    await ensureWorkspace();
    renderHeader();
    nav("panel_meetings");
  }

  // expose
  window.signIn = signIn;
  window.signUp = signUp;
  window.signOut = signOut;
  window.createWorkspace = createWorkspace;
  window.switchWorkspace = switchWorkspace;
  window.nav = nav;

  window.joinRoomNew = ()=> joinRoom(true);
  window.joinRoom = ()=> joinRoom(false);
  window.startCall = startCall;
  window.leaveRoom = leaveRoom;
  window.hangup = hangup;
  window.toggleMic = toggleMic;
  window.toggleCam = toggleCam;

  window.addEventListener("load", ()=>{
    // Wichtig: sofort boot ‚Äì wenn Supabase mal kurz nicht antwortet, bleibt Login sichtbar
    boot().catch(e=>{
      console.error(e);
      show("view_login");
      toast("Startfehler: "+(e?.message||e), "err");
    });
  });
</script>

<!-- LOGIN -->
<div id="view_login" class="min-h-screen flex items-center justify-center p-6">
  <div class="card w-full max-w-3xl p-8">
    <div class="flex items-center justify-between gap-4">
      <div>
        <div class="text-3xl font-black">CRM PRO</div>
        <div class="text-slate-500 font-semibold">Supabase Login ‚Ä¢ Admin ‚Ä¢ Meetings (WebRTC)</div>
      </div>
      <div class="px-3 py-2 rounded-xl bg-slate-900 text-white font-black">LIVE</div>
    </div>

    <div class="grid md:grid-cols-2 gap-6 mt-8">
      <div class="p-5 rounded-2xl bg-slate-50 border">
        <div class="font-black text-lg mb-3">Login</div>
        <input id="li_email" class="w-full border p-3 rounded-xl mb-2" placeholder="Email">
        <input id="li_pass" type="password" class="w-full border p-3 rounded-xl mb-3" placeholder="Passwort">
        <button class="btn bg-blue-600 text-white w-full" onclick="signIn()">Login</button>
      </div>

      <div class="p-5 rounded-2xl bg-slate-50 border">
        <div class="font-black text-lg mb-3">Signup</div>
        <input id="su_user" class="w-full border p-3 rounded-xl mb-2" placeholder="Username (optional)">
        <input id="su_email" class="w-full border p-3 rounded-xl mb-2" placeholder="Email">
        <input id="su_pass" type="password" class="w-full border p-3 rounded-xl mb-3" placeholder="Passwort">
        <button class="btn bg-slate-900 text-white w-full" onclick="signUp()">Account erstellen</button>
      </div>
    </div>

    <div class="mt-6 text-xs text-slate-500">
      Hinweis: <span class="mono">sb_publishable</span> ist ok im Browser. <span class="mono">sb_secret</span> niemals.
    </div>
  </div>
</div>

<!-- APP -->
<div id="view_app" class="hidden">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black">CP</div>
        <div>
          <div class="text-2xl font-black">CRM PRO</div>
          <div class="text-slate-500 font-semibold">
            Workspace: <span id="ws_name" class="font-black text-slate-900">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <div class="card px-4 py-3">
          <div class="font-black" id="hdr_name">‚Äî</div>
          <div class="text-xs text-slate-500">
            <span id="hdr_email">‚Äî</span> ‚Ä¢ <span id="hdr_uid" class="mono">‚Äî</span>
            <span id="hdr_admin" class="ml-2 inline-block px-2 py-1 rounded-full bg-red-100 text-red-700 font-black text-xs hidden">ADMIN</span>
          </div>
        </div>

        <div class="card px-3 py-2 flex items-center gap-2">
          <select id="ws_select" class="border rounded-xl p-2 font-black" onchange="switchWorkspace(this.value)"></select>
          <button class="btn bg-slate-900 text-white" onclick="createWorkspace()">+ Workspace</button>
        </div>

        <button class="btn bg-red-600 text-white" onclick="signOut()">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Sidebar -->
      <div class="lg:col-span-3">
        <div class="card p-3 grid gap-2">
          <button id="nav_panel_meetings" class="navbtn active" onclick="nav('panel_meetings')">üìπ Meetings</button>
          <button id="nav_panel_info" class="navbtn" onclick="nav('panel_info')">‚ÑπÔ∏è Info</button>
        </div>

        <div class="card p-4 mt-6">
          <div class="font-black mb-2">Meeting Status</div>
          <div class="text-sm text-slate-600 space-y-1">
            <div>Room: <span id="roomBadge" class="mono font-black">‚Äî</span></div>
            <div>Role: <span id="roleBadge" class="mono font-black">‚Äî</span></div>
            <div>Conn: <span id="connState" class="mono font-black">idle</span></div>
            <div class="flex gap-2 mt-2">
              <span id="micBadge" class="px-2 py-1 rounded-full bg-slate-200 font-black text-xs">‚Äî</span>
              <span id="camBadge" class="px-2 py-1 rounded-full bg-slate-200 font-black text-xs">‚Äî</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="lg:col-span-9">
        <!-- Meetings -->
        <div id="panel_meetings" data-panel class="card p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <div class="text-2xl font-black">Online-Meetings & Videoanrufe</div>
              <div class="text-slate-500 font-semibold">WebRTC + Supabase Realtime Signaling</div>
            </div>
            <div class="flex flex-wrap gap-2">
              <button class="btn bg-slate-900 text-white" onclick="joinRoomNew()">Neuen Raum</button>
              <button class="btn bg-slate-200" onclick="joinRoom()">Join</button>
              <button id="btnStartCall" class="btn bg-blue-600 text-white" onclick="startCall()">Call starten</button>
              <button id="btnHangup" class="btn bg-red-600 text-white" onclick="hangup()">Auflegen</button>
              <button class="btn bg-slate-200" onclick="leaveRoom()">Leave</button>
            </div>
          </div>

          <div class="mt-5 grid md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <input id="roomInput" class="w-full border rounded-2xl p-3 font-black mono" placeholder="Room-ID (z.B. room_ab12cd34)">
              <div class="text-xs text-slate-500 mt-2">
                Ablauf: 1) Raum erstellen oder joinen ‚Üí 2) Einer dr√ºckt ‚ÄúCall starten‚Äù ‚Üí 3) der andere akzeptiert automatisch.
              </div>
            </div>
            <div class="flex gap-2">
              <button id="btnMic" class="btn bg-slate-900 text-white w-full" onclick="toggleMic()">Mic aus</button>
              <button id="btnCam" class="btn bg-slate-900 text-white w-full" onclick="toggleCam()">Cam aus</button>
            </div>
          </div>

          <div class="mt-6 grid md:grid-cols-2 gap-4">
            <div class="rounded-2xl overflow-hidden border bg-slate-900">
              <div class="px-3 py-2 text-white font-black text-sm">Du</div>
              <video id="localVideo" autoplay playsinline muted class="w-full h-64 object-cover"></video>
            </div>
            <div class="rounded-2xl overflow-hidden border bg-slate-900">
              <div class="px-3 py-2 text-white font-black text-sm">Gegenstelle</div>
              <video id="remoteVideo" autoplay playsinline class="w-full h-64 object-cover"></video>
            </div>
          </div>

          <div class="mt-4 text-xs text-slate-500">
            Tipp: Wenn Remote-Video schwarz bleibt: Browser-Autoplay blockiert manchmal Audio/Video ‚Üí einmal in das Video klicken.
            F√ºr ‚Äúharte‚Äù Netzwerke brauchst du TURN (z.B. Twilio).
          </div>
        </div>

        <!-- Info -->
        <div id="panel_info" data-panel class="card p-6 hidden">
          <div class="text-2xl font-black">Warum hat dein altes HTML ‚Äúnix angezeigt‚Äù?</div>
          <div class="mt-3 text-slate-600 space-y-2">
            <div>‚Ä¢ H√§ufigster Grund: <b>Startfehler in JavaScript</b> ‚Üí Seite bleibt hidden.</div>
            <div>‚Ä¢ In dieser Version ist Login <b>standardm√§√üig sichtbar</b> und die App wird erst danach eingeblendet.</div>
            <div>‚Ä¢ Wenn du willst, erweitere ich das wieder auf: CRM, Tickets, Chat, Kalender, Drive, Admin usw.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // initial button states
  (function(){
    const disable = (id)=>{ const b=$(id); if(b) b.disabled=true; };
    disable("btnStartCall"); disable("btnHangup");
  })();
</script>

</body>
</html>
