<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CORE MASTER 2026 | SAAS MANAGEMENT</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <link rel="stylesheet" href="../style.css">
  
  <style>
    /* Spezifische Ergänzungen für das Black-Edition Feeling im Inhaltsbereich */
    .grid-top { display: grid; grid-template-columns: 1.6fr 1fr; gap: 20px; margin-bottom: 20px; }
    .flex-row { display: flex; gap: 12px; margin-bottom: 5px; }
    
    input, select { 
      width: 100%; padding: 11px; background: rgba(255,255,255,0.03); 
      border: 1px solid var(--glass-border); border-radius: 8px; 
      color: #fff; font-size: 13px; outline: none; margin-bottom: 10px; 
    }
    
    .btn-auto { background: #374151; color: #fff; border: none; border-radius: 8px; padding: 0 15px; cursor: pointer; font-size: 10px; font-weight: 800; height: 38px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; color: var(--text-muted); padding: 12px; font-size: 10px; border-bottom: 1px solid var(--glass-border); text-transform: uppercase; }
    td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 13px; }
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="sidebar-header">
      <div style="font-weight: 900; font-size: 20px; color: var(--accent);">CORE MASTER</div>
      <div style="font-size: 10px; color: var(--text-muted);">ADMINISTRATION 2026</div>
    </div>
    <div class="sidebar-content">
      <div class="nav-label">Konsole</div>
      <a href="../admin.html" class="nav-link"><i data-lucide="layout-dashboard"></i> Dashboard</a>
      
      <div class="nav-label">SaaS System</div>
      <a href="saas_freischaltung.html" class="nav-link active"><i data-lucide="user-plus"></i> SaaS Freischaltung</a>
      <a href="tarife.html" class="nav-link"><i data-lucide="tags"></i> Master Tarife</a>
      
      <div class="nav-label">Module</div>
      <a href="kunden.html" class="nav-link"><i data-lucide="users"></i> Kunden</a>
      <a href="mitarbeiter.html" class="nav-link"><i data-lucide="hard-hat"></i> Mitarbeiter</a>
      
      <div class="nav-label">System</div>
      <button class="nav-btn" style="color:var(--danger); margin-top:20px;" onclick="location.href='../index.html'"><i data-lucide="log-out"></i> Logout</button>
    </div>
  </aside>

  <main class="main">
    <div class="content">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin:0;">SaaS Lizenz-Management 2026</h2>
        <div style="display: flex; gap: 20px;">
          <div class="card-glass" style="padding: 10px 20px; margin:0;"><label>Aktiv</label> <span id="stat_active">0</span></div>
          <div class="card-glass" style="padding: 10px 20px; margin:0;"><label>Umsatz</label> <span id="stat_revenue">0 €</span></div>
        </div>
      </div>

      <div class="grid-top">
        <div class="card-glass">
          <h3>Kundeninstanz anlegen</h3>
          <div class="flex-row">
            <div style="flex:1;"><label>Firma</label><input type="text" id="c_name" placeholder="Name"></div>
            <div style="flex:1;"><label>E-Mail</label><input type="email" id="c_mail" placeholder="admin@firma.de"></div>
          </div>
          <div class="flex-row">
            <div style="flex:1;"><label>Vorname Admin</label><input type="text" id="c_fname" placeholder="Max"></div>
            <div style="flex:1;"><label>Nachname Admin</label><input type="text" id="c_lname" placeholder="Mustermann"></div>
          </div>
          <div class="flex-row">
            <div style="flex:1.5;"><label>Tarif-Paket (inkl. Mitarbeiter-Limit)</label><select id="c_package"></select></div>
            <div style="flex:1;"><label>Abrechnungszyklus</label><select id="c_cycle"><option value="1">Monatlich</option><option value="12">Jährlich</option></select></div>
          </div>
          <label>Individueller Login-Schlüssel (Token)</label>
          <div class="flex-row">
            <input type="text" id="c_token" style="flex:1;" placeholder="Wird generiert...">
            <button class="btn-auto" onclick="genToken()">AUTO</button>
          </div>
          <button class="btn-main" onclick="saveData()">LIZENZ AKTIVIEREN & SENDEN</button>
        </div>

        <div class="card-glass">
          <h3>Tarif Editor</h3>
          <label>Tarif Name</label><input type="text" id="p_name" placeholder="z.B. Enterprise">
          <label>Monatspreis (€)</label><input type="number" id="p_price" placeholder="499">
          <label>Max. Mitarbeiter</label><input type="number" id="p_limit" placeholder="100">
          <button class="btn-main" onclick="savePackage()" style="background:#374151">TARIF SPEICHERN</button>
          
          <div style="margin-top:20px;">
            <label>Aktuelle Preisliste</label>
            <div id="package-preview" style="font-size:11px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
              </div>
          </div>
        </div>
      </div>

      <div class="card-glass">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3 style="border:none; margin:0;">Aktive SaaS Instanzen</h3>
          <button onclick="exportPDF()" style="background:var(--gold); border:none; padding:8px 15px; border-radius:6px; font-weight:800; font-size:11px; cursor:pointer; color:black;">PDF EXPORT</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Firma</th>
              <th>Admin</th>
              <th>Paket</th>
              <th>Limit (MA)</th>
              <th>Umsatz</th>
              <th>Status</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="client-list"></tbody>
        </table>
      </div>

    </div>
  </main>

  <script src="../config.js"></script>
  <script>
    // Die Supabase Instanz wird aus config.js geladen (_supabase)
    let packages = []; let clients = [];
    lucide.createIcons();

    async function init() {
      await fetchPackages();
      await fetchClients();
    }

    async function fetchPackages() {
      const { data } = await _supabase.from('packages').select('*').order('price');
      packages = data || [];
      updateDropdowns();
    }

    async function fetchClients() {
      const { data } = await _supabase.from('clients').select('*').order('created_at', { ascending: false });
      clients = data || [];
      renderClients();
    }

    function updateDropdowns() {
      const sel = document.getElementById('c_package');
      // Hier steht jetzt auch das Mitarbeiter Limit im Dropdown (linke Spalte)
      if(sel) sel.innerHTML = packages.map(p => 
        `<option value="${p.name}">${p.name} (${p.employee_limi || 0} MA) | ${p.price}€</option>`
      ).join('');
      
      const pre = document.getElementById('package-preview');
      // Hier steht das Limit in der Übersicht (rechte Spalte)
      if(pre) pre.innerHTML = packages.map(p => 
        `<div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding:6px 0;">
          <span><strong>${p.name}</strong></span>
          <span style="color:var(--accent)">${p.employee_limi || 0} MA</span>
          <span>${p.price} €</span>
        </div>`
      ).join('');
    }

    async function savePackage() {
      const name = document.getElementById('p_name').value;
      const price = document.getElementById('p_price').value;
      const limit = document.getElementById('p_limit').value;
      if(!name || !price) return alert("Name und Preis benötigt");
      
      await _supabase.from('packages').upsert({ 
        name, 
        price: parseFloat(price), 
        employee_limi: parseInt(limit) 
      }, { onConflict: 'name' });
      
      fetchPackages();
    }

    async function saveData() {
      const client = {
        company: document.getElementById('c_name').value,
        email: document.getElementById('c_mail').value,
        fname: document.getElementById('c_fname').value,
        lname: document.getElementById('c_lname').value,
        token: document.getElementById('c_token').value,
        package_name: document.getElementById('c_package').value,
        billing_cycle: parseInt(document.getElementById('c_cycle').value),
        status: "Aktiv"
      };
      if(!client.company || !client.token) return alert("Bitte Firma und Token eingeben!");
      
      const { error } = await _supabase.from('clients').insert([client]);
      if(!error) { alert("Kundeninstanz erfolgreich angelegt!"); fetchClients(); }
    }

    function renderClients() {
      const tbody = document.getElementById('client-list');
      let totalRev = 0;
      tbody.innerHTML = clients.map((c) => {
        const p = packages.find(pkg => pkg.name === c.package_name) || {price:0, employee_limi: 0};
        const sum = (p.price * (c.billing_cycle || 1));
        totalRev += sum;
        return `
          <tr>
            <td><strong>${c.company}</strong></td>
            <td>${c.fname} ${c.lname}</td>
            <td><span style="color:var(--accent)">${c.package_name}</span></td>
            <td>${p.employee_limi} MA</td>
            <td>${sum.toFixed(2)} €</td>
            <td><span class="status-pill">Aktiv</span></td>
            <td><button onclick="deleteClient('${c.id}')" style="color:var(--danger); background:none; border:none; cursor:pointer; font-weight:800;">LÖSCHEN</button></td>
          </tr>`;
      }).join('');
      document.getElementById('stat_active').innerText = clients.length;
      document.getElementById('stat_revenue').innerText = totalRev.toLocaleString('de-DE') + " €";
    }

    async function deleteClient(id) {
      if(confirm("Möchten Sie diesen Kunden wirklich löschen?")) { 
        await _supabase.from('clients').delete().eq('id', id); 
        fetchClients(); 
      }
    }

    function genToken() {
      document.getElementById('c_token').value = "CM-" + Math.random().toString(36).substring(2, 7).toUpperCase() + "-" + Math.floor(Math.random() * 900 + 100);
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18); doc.text("CORE MASTER - KUNDENLISTE 2026", 14, 20);
      doc.autoTable({ 
        head: [['Firma', 'Paket', 'Limit', 'Token']], 
        body: clients.map(c => [c.company, c.package_name, (packages.find(p=>p.name===c.package_name)?.employee_limi || 0) + ' MA', c.token]),
        startY: 30 
      });
      doc.save("CORE_MASTER_Kunden_2026.pdf");
    }

    init();
  </script>
</body>
</html>
